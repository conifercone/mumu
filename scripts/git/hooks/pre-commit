#!/bin/sh

# è·å–æ‰€æœ‰è¢«æš‚å­˜çš„æ–‡ä»¶
changed_files=$(git diff --cached --name-only)

# è¿‡æ»¤å‡º Javaã€Properties å’Œ XML æ–‡ä»¶
java_files=$(echo "$changed_files" | grep '\.java$')
properties_files=$(echo "$changed_files" | grep '\.properties$')
xml_files=$(echo "$changed_files" | grep '\.xml$')

# åˆå§‹åŒ–æ ‡å¿—
pmd_needed=0
checkstyle_needed=0

# æ£€æŸ¥æ˜¯å¦æœ‰ Java æ–‡ä»¶ï¼Œè®¾ç½® PMD æ ‡å¿—
if [ ! -z "$java_files" ]; then
    pmd_needed=1
    checkstyle_needed=1 # Java æ–‡ä»¶ä¹Ÿéœ€è¦æ£€æŸ¥ Checkstyle
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ Properties æˆ– XML æ–‡ä»¶ï¼Œè®¾ç½® Checkstyle æ ‡å¿—
if [ ! -z "$properties_files" ] || [ ! -z "$xml_files" ]; then
    checkstyle_needed=1
fi

# å¦‚æœæ²¡æœ‰æ–‡ä»¶éœ€è¦æ£€æŸ¥ï¼Œç›´æ¥é€€å‡º
if [ $pmd_needed -eq 0 ] && [ $checkstyle_needed -eq 0 ]; then
    echo "ğŸŒ No relevant files changed, skipping PMD and Checkstyle."
    exit 0
fi

# è¾“å‡ºä¿¡æ¯
if [ $pmd_needed -eq 1 ]; then
    echo "ğŸ¦‰ Running PMD on changed Java files..."
    ./gradlew pmdMain
    if [ $? -ne 0 ]; then
        echo "ğŸŒ¥ï¸ PMD check failed. Please fix the issues before committing."
        exit 1
    fi
fi

if [ $checkstyle_needed -eq 1 ]; then
    echo "ğŸ¦‰ Running Checkstyle on changed Java, Properties, and XML files..."
    ./gradlew checkstyleMain
    if [ $? -ne 0 ]; then
        echo "ğŸŒ¥ï¸ Checkstyle check failed. Please fix the issues before committing."
        exit 1
    fi
fi

echo "ğŸ‰ PMD and Checkstyle checks passed."
