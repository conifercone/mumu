#!/bin/sh

# è·å–æ‰€æœ‰è¢«æš‚å­˜çš„æ–‡ä»¶
changed_files=$(git diff --cached --name-only)

# è¿‡æ»¤å‡º Javaã€Properties å’Œ XML æ–‡ä»¶
java_files=$(echo "$changed_files" | grep '\.java$')
kotlin_files=$(echo "$changed_files" | grep '\.kt$')
properties_files=$(echo "$changed_files" | grep '\.properties$')
xml_files=$(echo "$changed_files" | grep '\.xml$')

# åˆå§‹åŒ–æ ‡å¿—
pmd_needed=0
checkstyle_needed=0
update_license_needed=0

# æ£€æŸ¥æ˜¯å¦æœ‰ Java æ–‡ä»¶ï¼Œè®¾ç½® PMD æ ‡å¿—
if [ ! -z "$java_files" ]; then
    pmd_needed=1
    checkstyle_needed=1 # Java æ–‡ä»¶ä¹Ÿéœ€è¦æ£€æŸ¥ Checkstyle
    update_license_needed=1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ Kotlin æ–‡ä»¶
if [ ! -z "$kotlin_files" ]; then
    update_license_needed=1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ Properties æˆ– XML æ–‡ä»¶ï¼Œè®¾ç½® Checkstyle æ ‡å¿—
if [ ! -z "$properties_files" ] || [ ! -z "$xml_files" ]; then
    checkstyle_needed=1
fi

# å¦‚æœæ²¡æœ‰æ–‡ä»¶éœ€è¦æ£€æŸ¥ï¼Œç›´æ¥é€€å‡º
if [ $pmd_needed -eq 0 ] && [ $checkstyle_needed -eq 0 ]  && [ $update_license_needed -eq 0 ]; then
    echo "â˜€ï¸ No relevant files changed, skipping PMD and Checkstyle and Update license."
    exit 0
fi

# è¾“å‡ºä¿¡æ¯
if [ $pmd_needed -eq 1 ]; then
    echo "ğŸ¦‰ Running PMD on changed Java files..."
    if ./gradlew clean pmdMain; then
      echo "ğŸ‰ PMD checks passed.";
    else
      echo "ğŸŒ¥ï¸ PMD check failed. Please fix the issues before committing.";
      exit 1
    fi
fi

if [ $checkstyle_needed -eq 1 ]; then
    echo "ğŸ¦‰ Running Checkstyle on changed Java, Properties, and XML files..."
    if ./gradlew clean checkstyleMain; then
      echo "ğŸ‰ Checkstyle checks passed.";
    else
      echo "ğŸŒ¥ï¸ Checkstyle check failed. Please fix the issues before committing.";
      exit 1
    fi
fi

if [ $update_license_needed -eq 1 ]; then
  echo "ğŸ¦‰ Running Update license on changed Java or Kotlin files..."
  # æ‰§è¡Œupdate_licenseè„šæœ¬
  ./update_license.sh
  # æš‚å­˜å˜æ›´
  git add .
  echo "ğŸ‰ License updated."
fi
