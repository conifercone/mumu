<?xml version="1.0" encoding="UTF-8" ?>
<!--

    Copyright (c) 2024-2024, the original author or authors.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<Configuration status="WARN" name="prod">
  <Properties>
    <!-- @formatter:off -->
    <!-- 日志目录：${mumu.log.path}/logs/${spring.application.name} -->
    <Property name="LOG_PATH">${spring:mumu.log.path}/logs/${spring:spring.application.name:-mumu}</Property>
    <!-- 日志文件名前缀：应用名 -->
    <Property name="LOGFILE_NAME">${spring:spring.application.name:-mumu}</Property>
    <!-- 异常输出（dev 使用完整栈信息） -->
    <Property name="LOG_EXCEPTION_CONVERSION_WORD">-%xEx{full}</Property>
    <!-- 日志级别 + appName + traceId/spanId -->
    <Property name="LOG_LEVEL_PATTERN">%5p [${spring:spring.application.name:-mumu},%X{traceId},%X{spanId}]</Property>
    <!-- 日期格式 -->
    <Property name="LOG_DATEFORMAT_PATTERN">yyyy-MM-dd'T'HH:mm:ss.SSSXXX</Property>
    <!-- @formatter:on -->
  </Properties>

  <Appenders>
    <!-- @formatter:off -->
    <Console name="Console" target="SYSTEM_OUT">
      <PatternLayout charset="UTF-8" pattern="%d{${LOG_DATEFORMAT_PATTERN}} ${LOG_LEVEL_PATTERN:-%5p} ${sys:PID:- } --- [%15.15t] %-40.40logger{39} : %m%n${LOG_EXCEPTION_CONVERSION_WORD}"/>
      <ThresholdFilter level="WARN" onMatch="ACCEPT" onMismatch="DENY"/>
    </Console>
    <!-- INFO日志文件输出：按天 + 按大小滚动，归档到 archive 目录，压缩为 .gz -->
    <RollingFile name="RollingInfoFile" fileName="${LOG_PATH}/${LOGFILE_NAME}-info.log" filePattern="${LOG_PATH}/archive/${LOGFILE_NAME}-info-%d{yyyy-MM-dd}-%i.log.gz">
      <PatternLayout charset="UTF-8" pattern="%d{${LOG_DATEFORMAT_PATTERN}} ${LOG_LEVEL_PATTERN:-%5p} %-5pid --- [%t] %-40.40c{1.} L%-4line : %m%n${LOG_EXCEPTION_CONVERSION_WORD}"/>
      <ThresholdFilter level="INFO" onMatch="ACCEPT" onMismatch="DENY"/>
      <Policies>
        <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
        <SizeBasedTriggeringPolicy size="250MB" />
      </Policies>
      <DefaultRolloverStrategy max="100">
        <Delete basePath="${LOG_PATH}/archive" maxDepth="1">
          <!-- 只匹配归档文件 -->
          <IfFileName glob="${LOGFILE_NAME}-info-*.log.gz"/>
          <!-- 只删除 30 天前的 -->
          <IfLastModified age="30d"/>
        </Delete>
      </DefaultRolloverStrategy>
    </RollingFile>
    <!-- ERROR日志文件输出：按天 + 按大小滚动，归档到 archive 目录，压缩为 .gz -->
    <RollingFile name="RollingErrorFile" fileName="${LOG_PATH}/${LOGFILE_NAME}-error.log" filePattern="${LOG_PATH}/${LOGFILE_NAME}-error-%d{yyyy-MM-dd}-%i.log.gz">
      <PatternLayout charset="UTF-8" pattern="%d{${LOG_DATEFORMAT_PATTERN}} ${LOG_LEVEL_PATTERN:-%5p} %-5pid --- [%t] %-40.40c{1.} L%-4line : %m%n${LOG_EXCEPTION_CONVERSION_WORD}"/>
      <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY"/>
      <Policies>
        <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
        <SizeBasedTriggeringPolicy size="100MB" />
      </Policies>
      <DefaultRolloverStrategy max="100">
        <Delete basePath="${LOG_PATH}/archive" maxDepth="1">
          <!-- 只匹配 error 归档 -->
          <IfFileName glob="${LOGFILE_NAME}-error-*.log.gz"/>
          <!-- 只删除 60 天前的 -->
          <IfLastModified age="60d"/>
        </Delete>
      </DefaultRolloverStrategy>
    </RollingFile>
    <!-- @formatter:on -->
  </Appenders>

  <Loggers>
    <!--Root level logger to control overall logging-->
    <AsyncRoot level="INFO" includeLocation="true">
      <AppenderRef ref="Console"/>
      <AppenderRef ref="RollingInfoFile"/>
      <AppenderRef ref="RollingErrorFile"/>
    </AsyncRoot>

    <!-- 降低 Kafka 客户端日志噪音 -->
    <logger name="org.apache.kafka" level="warn" additivity="false"/>
  </Loggers>
</Configuration>
